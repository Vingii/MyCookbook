@page "/export"
@using MyCookbook.Components;
@using MyCookbook.Data
@using MyCookbook.Data.CookbookDatabase
@using Microsoft.Extensions.Localization;
@using MyCookbook.Services;
@using System.Security.Claims;
@using System.IO;
@using Microsoft.AspNetCore.Components.Forms
@inject ILanguageDictionary LanguageDictionary
@inject IStringLocalizer<RecipeViewer> Localizer
@inject ILogger<RecipeShared> Logger
@inject LanguageNotifier LanguageNotifier
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inherits OwningComponentBase<CookbookDatabaseService>
@implements IDisposable

<PageTitle>Export</PageTitle>

<h3>Cookbook Data Management</h3>

<br />

<div>
    <h4>Export Data</h4>
    <p>Click the button below to export your cookbook data to a JSON file.</p>
    <button class="btn btn-primary" @onclick="ExportData">Export Cookbook Data</button>
</div>

<br />

<div>
    <h4>Import Data</h4>
    <p>Select a JSON file to import cookbook data. This will overwrite existing data.</p>
    <InputFile OnChange="LoadFileForImport" accept=".json" />
    @if (!string.IsNullOrEmpty(importMessage))
    {
        <p class="@(importSuccess ? "text-success" : "text-danger")">@importMessage</p>
    }
</div>


@code
{
    [Parameter]
    public string Id { get; set; } = "";

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationStateTask { get; set; }
    private string _userIdentityName = "";

    private string importMessage = "";
    private bool importSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        LanguageNotifier.SubscribeLanguageChange(this);

        if (authenticationStateTask != null)
        {
            var user = (await authenticationStateTask).User;
            if (user.Identity != null && user.FindFirst(ClaimTypes.Name)?.Value.StartsWith("guest-", StringComparison.InvariantCultureIgnoreCase) == false)
            {
                _userIdentityName = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
            }
        }
    }

    public void Dispose() => LanguageNotifier.UnsubscribeLanguageChange(this);

    private async Task ExportData()
    {
        try
        {
            var exportString = await Service.Export(_userIdentityName);
            var fileName = $"CookbookData_{DateTime.Now:yyyyMMdd_HHmmss}.json";

            await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", fileName, exportString);

            Logger.LogInformation("Cookbook data exported successfully.");
            Snackbar.Add("Your cookbook data has been exported successfully.", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting cookbook data.");
            Snackbar.Add($"An error occurred during export: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadFileForImport(InputFileChangeEventArgs e)
    {
        importMessage = "";
        importSuccess = false;

        foreach (var file in e.GetMultipleFiles(1))
        {
            try
            {
                using var reader = new StreamReader(file.OpenReadStream());
                var content = await reader.ReadToEndAsync();

                await Service.Import(content, _userIdentityName);

                importSuccess = true;
                importMessage = "Cookbook data imported successfully! You might need to refresh to see changes.";
                Logger.LogInformation("Cookbook data imported successfully.");
                Snackbar.Add("Your cookbook data has been imported successfully. Please navigate away and back to see the changes.", Severity.Success);
            }
            catch (Exception ex)
            {
                importSuccess = false;
                importMessage = $"Error importing data: {ex.Message}";
                Logger.LogError(ex, "Error importing cookbook data.");
                Snackbar.Add($"Error importing data: {ex.Message}", Severity.Error);
            }
        }
    }
}