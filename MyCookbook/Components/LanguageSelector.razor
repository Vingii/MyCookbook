@using Microsoft.AspNetCore.Localization;
@using MyCookbook.Services;
@using System.Globalization;
@using System.Web;
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject LanguageNotifier LanguageNotifier
@inject CultureProvider CultureProvider
@inject UserSettings UserSettings

<MudSelect @ref="selector" T="string" Dense="true" Margin="Margin.Dense" Value="@Culture" ValueChanged="@OnCultureChanged" AnchorOrigin="Origin.BottomCenter" Disabled="@DisableInteractivity">
    @foreach (var (culture, language) in Languages)
    {
        <MudSelectItem Value="@(culture)">@language</MudSelectItem>
    }
</MudSelect>

@code {
    private Dictionary<string, string> Languages { get; set; } = new();

    private MudSelect<string>? selector;

    private string? _culture;
    private string? Culture
    {
        get => _culture;
    }

    private bool DisableInteractivity => NavigationManager.ToBaseRelativePath(NavigationManager.Uri).StartsWith("Account");

    private Lazy<IJSObjectReference> LanguageSelectorModule = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        LanguageSelectorModule = new(await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/Cookies.js"));
    }

    protected override async Task OnInitializedAsync()
    {
        _culture = await UserSettings.GetLanguage();
        LanguageNotifier.NotifyLanguageChange();
    }

    protected override void OnInitialized()
    {
        Languages = CultureProvider.SupportedLanguages;
    }

    private async Task OnCultureChanged(string newCulture)
    {
        if (newCulture == null || newCulture == _culture)
        {
            return;
        }

        _culture = newCulture;
        await OnChangeLanguage(newCulture);
    }

    private async Task OnChangeLanguage(string newCulture)
    {
        await UserSettings.SetLanguage(newCulture);
        await LanguageSelectorModule.Value.InvokeVoidAsync("addCookies", CookieRequestCultureProvider.DefaultCookieName,
            CookieRequestCultureProvider.MakeCookieValue(new(UserSettings.Culture, UserSettings.Culture)));
        LanguageNotifier.NotifyLanguageChange();
    }

    public async ValueTask DisposeAsync()
    {
        if (LanguageSelectorModule.IsValueCreated)
        {
            await LanguageSelectorModule.Value.DisposeAsync();
        }
    }
}