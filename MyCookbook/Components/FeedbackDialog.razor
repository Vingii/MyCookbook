@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Localization
@using MyCookbook.Services
@using System.Security.Claims
@inject IStringLocalizer<FeedbackDialog> Localizer
@inject LanguageNotifier LanguageNotifier
@inject IFeedbackProvider FeedbackProvider
@implements IDisposable

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            @Localizer["Feedback"]
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText>@Localizer["FeedbackPrompt"]</MudText>
        <MudTextField @bind-Value="FeedbackText" Variant="Variant.Text" Lines="1" AutoGrow="true"></MudTextField>
        
        <div class="mt-4">
            <MudFileUpload T="IReadOnlyList<IBrowserFile>" Accept=".png, .jpg" FilesChanged="UploadFiles" MaximumFileCount="10">
                <ButtonTemplate>
                    <MudButton HtmlTag="label"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.CloudUpload"
                               for="@context.Id">
                        Add images
                    </MudButton>
                </ButtonTemplate>
            </MudFileUpload>
        </div>

        @if (_filesToUpload != null)
        {
            <MudList T="string">
                @foreach (var file in _filesToUpload)
                {
                    <MudListItem Icon="@Icons.Material.Filled.AttachFile">
                        @file.Name <code>@file.Size bytes</code>
                    </MudListItem>
                }
            </MudList>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@Localizer["Cancel"]</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">@Localizer["Send"]</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationStateTask { get; set; }
    private string _userIdentityName = "";

    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; }

    private string FeedbackText { get; set; } = "";
    IList<IBrowserFile> _filesToUpload = new List<IBrowserFile>();

    private void UploadFiles(IReadOnlyList<IBrowserFile> files)
    {
        foreach (var file in files)
        {
            _filesToUpload.Add(file);
        }
    }

    private async void Submit()
    {
        if (_userIdentityName == string.Empty)
        {
            MudDialog.Close(DialogResult.Ok(new FeedbackResult()));
        }

        try
        {
            var result = new FeedbackResult
                {
                    Text = this.FeedbackText,
                    Files = _filesToUpload.AsReadOnly()
                };
            await FeedbackProvider.ProvideFeedback(result.Text, result.Files, _userIdentityName);
            MudDialog.Close(DialogResult.Ok(result));
        }
        catch
        {
            MudDialog.Close(DialogResult.Ok(new FeedbackResult()));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (authenticationStateTask != null)
        {
            var user = (await authenticationStateTask).User;
            if (user.Identity != null && user.FindFirst(ClaimTypes.Name)?.Value.StartsWith("guest-", StringComparison.InvariantCultureIgnoreCase) == false)
            {
                _userIdentityName = user.FindFirst(ClaimTypes.Name)?.Value ?? "";
            }
        }
    }

    private void Cancel() => MudDialog.Cancel();

    protected override void OnInitialized() => LanguageNotifier.SubscribeLanguageChange(this);
    public void Dispose() => LanguageNotifier.UnsubscribeLanguageChange(this);
}