@using Microsoft.AspNetCore.Localization;
@using Microsoft.Extensions.Localization
@using MyCookbook.Data
@using MyCookbook.Data.CookbookDatabase
@using MyCookbook.Services;
@using System.Globalization;
@using System.Web;
@using MyCookbook.Utils
@inject IStringLocalizer<RecipeTable> Localizer
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILogger<RecipeTable> Logger
@inject IDialogService DialogService
@inject LanguageNotifier LanguageNotifier
@inject CultureProvider CultureProvider
@inject UserSettings UserSettings
@implements IDisposable
@inherits OwningComponentBase<CookbookDatabaseService>

<MudTable @ref="_tableRef" Items="@Recipes" Hover="true" Breakpoint="Breakpoint.None" Loading="@_loading" LoadingProgressColor="Color.Info" Dense="true"
          RowEditCommit="CommitTableEdit" CanCancelEdit="true" EditButtonPosition="@TableEditButtonPosition.End"
          EditTrigger="@TableEditTrigger.EditButton" Filter="new Func<Recipe, bool>(Filter)" AllowUnsorted="false"
          RowsPerPage="@_rowsPerPage" RowsPerPageChanged="async (rows) => await SetRowsPerPage(rows)"
          GroupHeaderStyle="background-color:var(--mud-palette-background-grey)" GroupFooterClass="mb-4">
    <ToolBarContent>
        <MudText Typo="Typo.h6">@TableName</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="_recipeSearch" Placeholder="@Localizer["Search"]" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel InitialDirection="SortDirection.Ascending" SortBy="new Func<Recipe, object>(x => x.Name)">@Localizer["Name"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Recipe, object>(x => x.Category)">@Localizer["Category"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Recipe, object>(x => x.Duration ?? 0)">@Localizer["Duration"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Recipe, object>(x => x.LastCooked ?? DateTime.MinValue)">@Localizer["Cooked"]</MudTableSortLabel></MudTh>
    </HeaderContent>
    <GroupHeaderTemplate Context="group">
        <MudTh Class="mud-table-cell-custom-group" colspan="5">
            @($"{Localizer["Category"]}: {(string.IsNullOrEmpty(group.Key?.ToString()) ? Localizer["Uncategorized"] : group.Key)}")
        </MudTh>
    </GroupHeaderTemplate>
    <RowTemplate Context="recipe">
        <MudTd DataLabel="@Localizer["Name"]" Class="cursor-pointer" @onmousedown="@(async (e) => await OpenRecipe(e, recipe))">
            @if (recipe.UserName == UserIdentityName)
            {
                <b>@recipe.Name</b>
            }
            else
            {
                @recipe.Name
            }
        </MudTd>
        <MudTd DataLabel="@Localizer["Category"]" Class="cursor-pointer" @onmousedown="@(async (e) => await OpenRecipe(e, recipe))">@recipe.Category</MudTd>
        <MudTd DataLabel="@Localizer["Duration"]" Class="cursor-pointer" @onmousedown="@(async (e) => await OpenRecipe(e, recipe))">@recipe.DurationText</MudTd>
        <MudTd DataLabel="@Localizer["Cooked"]" Class="cursor-pointer" @onmousedown="@(async (e) => await OpenRecipe(e, recipe))">@(recipe.LastCooked?.ToString("d", UserSettings.Culture) ?? "-")</MudTd>
        <MudTd Style="text-align:right">
            @if (_signedIn)
            {
                @if (Editable)
                {
                    <MudIcon Class="ma-0 cursor-pointer" Icon="@Icons.Material.Outlined.Delete" @onclick="@(async () => await DeleteRecipe(recipe))" Size="Size.Small"></MudIcon>
                }
                <MudIcon Class="ma-0 cursor-pointer" Icon="@Icons.Material.Outlined.ContentCopy" @onclick="@(async () => await CloneRecipe(recipe))" Size="Size.Small"></MudIcon>
                <MudIcon Class="ma-0 cursor-pointer" Icon="@(recipe.IsFavorite(UserIdentityName) ? Icons.Material.Outlined.Star : Icons.Material.Outlined.StarBorder)"
                         @onclick="@(async () => await ToggleFavorite(recipe))" Size="Size.Small"></MudIcon>
            }
        </MudTd>
    </RowTemplate>
    <RowEditingTemplate Context="recipe">
        <MudTd DataLabel="@Localizer["Name"]">
            <MudTextField Immediate="true" @bind-Value="@recipe.Name" OnKeyPress="CommitEdit" />
        </MudTd>
        <MudTd DataLabel="@Localizer["Category"]">
            <MudAutocomplete T="string"
                             Label="@Localizer["Category"]"
                             @bind-Value="@recipe.Category"
                             SearchFunc="@SearchCategories"
                             Variant="Variant.Text"
                             Immediate="true"
                             Clearable="true"
                             ResetValueOnEmptyText="true"
                             CoerceText="false"
                             CoerceValue="true"
                             OnKeyDown="CommitEdit"
                             SelectValueOnTab="true"
                             Dense="true" />
        </MudTd>
        <MudTd DataLabel="@Localizer["Duration"]">
            <MudTextField Immediate="true" @bind-Value="@recipe.DurationText" OnKeyPress="CommitEdit" />
        </MudTd>
    </RowEditingTemplate>
    <EditButtonContent Context="button">
        @if (Editable && _signedIn)
        {
            <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" Disabled="@button.ButtonDisabled" />
        }
    </EditButtonContent>
    <PagerContent>
        @if (Pagination && _signedIn)
        {
            <MudTablePager RowsPerPageString="@Localizer["RowsPerPage"]" InfoFormat="@($"{{first_item}}-{{last_item}} {Localizer["of"]} {{all_items}}")" />
        }
    </PagerContent>
</MudTable>

@code {
    [Parameter] public string UserIdentityName { get; set; } = string.Empty;
    [Parameter] public bool Editable { get; set; }
    [Parameter] public bool Pagination { get; set; } = true;
    [Parameter] public string TableName { get; set; } = string.Empty;
    [Parameter] public Func<Task<IEnumerable<Recipe>>> RecipeGetter { get; set; } = default!;

    private int _rowsPerPage = 10;

    public CookbookDatabaseService DbService => Service;
    public List<Recipe> Recipes = new List<Recipe>();

    private bool _signedIn = true;
    private bool _loading = true;
    private string? _recipeSearch;


    private MudTable<Recipe> _tableRef = default!;

    protected override async Task OnInitializedAsync()
    {
        LanguageNotifier.SubscribeLanguageChange(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        var rowsPerPagePreference = await Service.GetUserPreference("RowsPerPage", UserIdentityName);
        _rowsPerPage = rowsPerPagePreference != null && int.TryParse(rowsPerPagePreference, out var rowsPerPage) ? rowsPerPage : 10;
        StateHasChanged();
    }

    public async Task Load()
    {
        if (!_loading) return;
        _loading = false;
        await InvokeAsync(async () =>
        {
            await RefreshRecipes();
        });
    }

    private async Task SetRowsPerPage(int rows)
    {
        _rowsPerPage = rows;
        await Service.UpdateUserPreference("RowsPerPage", rows.ToString(), UserIdentityName);
    }

    private async Task OpenRecipe(MouseEventArgs e, Recipe recipe)
    {
        if (e.Button == 1)
        {
            string url;
            if (recipe.UserName == UserIdentityName)
            {
                url = $"Recipe/{recipe.Guid}";
            }
            else
            {
                url = $"Recipe/Shared/{recipe.Guid}";
            }

            await JSRuntime.InvokeVoidAsync("open", url, "_blank");
        }
        else if (e.Button == 0)
        {
            if (recipe.UserName != UserIdentityName)
            {
                NavigationManager.NavigateTo($"Recipe/Shared/{recipe.Guid}");
                return;
            }

            if (!_signedIn) return;
            NavigationManager.NavigateTo($"Recipe/{recipe.Guid}");
        }
    }

    private void CommitEdit(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            var item = _tableRef.SelectedItem;
            _tableRef.SetEditingItem(null);
            CommitTableEdit(item);
        }
    }

    private void CommitTableEdit(object element)
    {
        var recipe = (Recipe)element;
        var result = Task.Run(() => @Service.UpdateRecipeAsync(recipe, UserIdentityName)).Result;
        StateHasChanged();
    }

    private async Task DeleteRecipe(Recipe recipe)
    {
        try
        {
            var options = new DialogOptions { CloseOnEscapeKey = true };
            var parameters = new DialogParameters<ConfirmationDialog>();
            parameters.Add(x => x.Action, $"{Localizer["DeleteRecipe"]} {recipe.Name}");
            var dialog = await DialogService.ShowAsync<ConfirmationDialog>(Localizer["DeleteRecipe"].Value.CapitalizeFirst(), parameters, options);
            var dialogResult = await dialog.Result;

            if (!dialogResult.Canceled)
            {
                var createResult = await @Service.DeleteRecipeAsync(recipe, UserIdentityName);
                await RefreshRecipes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete recipe.");
        }
    }

    private async Task CloneRecipe(Recipe recipe)
    {
        var result = await @Service.CloneRecipeAsync(recipe, UserIdentityName);
        await RefreshRecipes();
    }

    private async Task ToggleFavorite(Recipe recipe)
    {
        if (recipe.IsFavorite(UserIdentityName))
        {
            await Service.DeleteFavoriteAsync(recipe.Id, UserIdentityName);
        }
        else
        {
            await Service.AddFavoriteAsync(recipe, UserIdentityName);
        }
        await RefreshRecipes();
    }

    public async Task RefreshRecipes()
    {
        if (!string.IsNullOrEmpty(UserIdentityName))
        {
            Recipes = (await RecipeGetter()).ToList();
            _signedIn = true;
        }
        else
        {
            Recipes = new List<Recipe>()
            {
                new Recipe()
                {
                    Name = Localizer["NotSignedIn"]
                }
            };
            _signedIn = false;
        }
        StateHasChanged();
    }

    private async Task AddRecipe()
    {
        try
        {
            var options = new DialogOptions { CloseOnEscapeKey = true };
            var parameters = new DialogParameters<NewEntryDialog>();
            parameters.Add(x => x.EntryType, Localizer["recipe"]);
            var dialog = await DialogService.ShowAsync<NewEntryDialog>("New recipe", parameters, options);
            var dialogResult = await dialog.Result;

            if (!dialogResult.Canceled)
            {
                var recipeName = dialogResult.Data.ToString();
                var recipe = new Recipe { Name = recipeName };
                var createResult = await @Service.CreateRecipeAsync(recipe, UserIdentityName);
                await RefreshRecipes();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create recipe.");
        }
    }

    private bool Filter(Recipe recipe)
    {
        if (string.IsNullOrWhiteSpace(_recipeSearch))
            return true;
        if (recipe.Name != null && recipe.Name.Contains(_recipeSearch, StringComparison.OrdinalIgnoreCase))
            return true;
        if (recipe.Category != null && recipe.Category.Contains(_recipeSearch, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private async Task<IEnumerable<string>> SearchCategories(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Recipes.Select(x => x.Category).Distinct().Order();

        return Recipes.Select(x => x.Category).Distinct().Where(x => x != null && x.Contains(value)).Order();
    }

    public async ValueTask DisposeAsync()
    {
        LanguageNotifier.UnsubscribeLanguageChange(this);
    }
}